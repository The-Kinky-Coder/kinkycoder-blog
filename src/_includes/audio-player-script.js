  import WaveSurfer from '/js/wavesurfer.esm.js';

  // We wrap everything in a function to avoid global scope pollution
  function initAudioPlayers() {
    const players = document.querySelectorAll('.audio-player');

    players.forEach(player => {
      // Check if we already set this one up to prevent duplicates
      if (player.dataset.initialized) return;
      player.dataset.initialized = "true";

      const url = player.dataset.url;
      const id = player.id; // Grab the ID generated by the shortcode

      // Scoped selectors: We find elements relative to the document using the unique ID
      const containerId = `#${id}-waveform`;
      const playPauseBtn = document.getElementById(`${id}-btn`);
      const playIcon = document.getElementById(`${id}-play`);
      const pauseIcon = document.getElementById(`${id}-pause`);
      const currentTime = document.getElementById(`${id}-current`);
      const totalDuration = document.getElementById(`${id}-total`);
      const volumeSlider = document.getElementById(`${id}-volume`);
      const muteBtn = document.getElementById(`${id}-mute`);
      const volIcon = document.getElementById(`${id}-vol-icon`);
      const muteIcon = document.getElementById(`${id}-mute-icon`);

      const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const waveColor = isDarkMode ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.2)';

      const commonOptions = {
        container: containerId,
        waveColor: waveColor,
        progressColor: '#f50',
        url: url,
        height: 60,
        barWidth: 3,
        barGap: 2,
        barRadius: 3,
        cursorColor: '#f50',
        cursorWidth: 2,
        dragToSeek: true,
        normalize: true,
      };

      let wavesurfer;
      let lastVolume = 1;

      function createWaveSurfer(extraOptions = {}) {
        const options = { ...commonOptions, ...extraOptions };
        wavesurfer = WaveSurfer.create(options);

        playPauseBtn.addEventListener('click', () => wavesurfer.playPause());

        wavesurfer.on('play', () => {
          playIcon.style.display = 'none';
          pauseIcon.style.display = 'block';
        });

        wavesurfer.on('pause', () => {
          playIcon.style.display = 'block';
          pauseIcon.style.display = 'none';
        });

        // Volume Logic
        const updateSlider = (value) => {
          const percentage = value * 100;
          volumeSlider.style.background = `linear-gradient(to right, #f50 ${percentage}%, var(--border, #dee2e6) ${percentage}%)`;
        };
        updateSlider(volumeSlider.value);

        volumeSlider.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          wavesurfer.setVolume(value);
          lastVolume = value;
          updateMuteIcon(value === 0);
          updateSlider(value);
        });

        muteBtn.addEventListener('click', () => {
          const currentVolume = wavesurfer.getVolume();
          if (currentVolume > 0) {
            lastVolume = currentVolume;
            wavesurfer.setVolume(0);
            volumeSlider.value = 0;
            updateMuteIcon(true);
            updateSlider(0);
          } else {
            const newVolume = lastVolume || 1;
            wavesurfer.setVolume(newVolume);
            volumeSlider.value = newVolume;
            updateMuteIcon(false);
            updateSlider(newVolume);
          }
        });

        function updateMuteIcon(isMuted) {
          if (isMuted) {
            volIcon.style.display = 'none';
            muteIcon.style.display = 'block';
          } else {
            volIcon.style.display = 'block';
            muteIcon.style.display = 'none';
          }
        }

        const formatTime = (seconds) => {
          const minutes = Math.floor(seconds / 60);
          const secondsRemainder = Math.floor(seconds % 60);
          const paddedSeconds = secondsRemainder < 10 ? `0${secondsRemainder}` : secondsRemainder;
          return `${minutes}:${paddedSeconds}`;
        };

        wavesurfer.on('decode', (duration) => totalDuration.textContent = formatTime(duration));
        wavesurfer.on('ready', (duration) => totalDuration.textContent = formatTime(duration));
        wavesurfer.on('timeupdate', (currentTimeSeconds) => currentTime.textContent = formatTime(currentTimeSeconds));

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
          wavesurfer.setOptions({
            waveColor: event.matches ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.2)'
          });
        });
      }

      // Try to load peaks
      const jsonUrl = url.replace(/\.[^/.]+$/, ".json");
      fetch(jsonUrl)
        .then(response => {
          if (!response.ok) throw new Error('No peaks');
          return response.json();
        })
        .then(data => {
          if (data && data.data) {
            createWaveSurfer({ peaks: [data.data] });
          } else {
            createWaveSurfer();
          }
        })
        .catch(() => {
          createWaveSurfer();
        });
    });
  }

  // Init when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAudioPlayers);
  } else {
    initAudioPlayers();
  }